services:
  imagenetviewer:
    image: imagenetviewer:local
    container_name: imagenetviewer
    build:
      context: .
      dockerfile: ImageNetViewer/Dockerfile
    ports:
      - "6789:8080"
    environment:
      # Override DB settings for in-container connectivity to the sqlserver service
      - Database__ConnectionString=Server=sqlserver,1433;Database=ImageNet;User ID=ImageNetUser;Password=ImageNet@123!;TrustServerCertificate=True;
      - Database__Server=sqlserver
      - Database__Port=1433
      - Database__UserId=ImageNetUser
      - Database__Password=ImageNet@123!
      - Database__Trusted_Connection=False
      - Database__TrustServerCertificate=True
    depends_on:
      sqlserver:
        condition: service_started
      sqlserver-init:
        condition: service_completed_successfully

  # Microsoft SQL Server for local development
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: imagenet-mssql
    environment:
      - ACCEPT_EULA=Y
      # Strong SA password for local development only. You may change it if needed.
      - MSSQL_SA_PASSWORD=LocalStrong!Passw0rd
      - MSSQL_PID=Developer
    user: root
    ports:
      - "9876:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P LocalStrong!Passw0rd -C -Q 'SELECT 1' || exit 1" ]
      interval: 10s
      retries: 10
      start_period: 10s
      timeout: 3s

  # One-off initializer to create the ImageNet database and the ImageNetUser login for local use
  sqlserver-init:
    # Use the same SQL Server image that is already pulled successfully; it contains sqlcmd tools
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: imagenet-mssql-init
    user: root
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      # Needed by the base image when invoking mssql tools binaries
      - ACCEPT_EULA=Y
      - SA_PASSWORD=LocalStrong!Passw0rd
    # Run the init script directly with bash (avoid login shell/profile side effects)
    entrypoint: ["/bin/bash", "/docker-entrypoint-initdb.d/init.sh"]

    volumes:
      - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro

    restart: "no"

volumes:
  mssql_data:
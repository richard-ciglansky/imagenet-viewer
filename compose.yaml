services:
  imagenetviewer:
    image: imagenetviewer
    build:
      context: .
      dockerfile: ImageNetViewer/Dockerfile
    depends_on:
      - sqlserver

  # Microsoft SQL Server for local development
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: imagenet-mssql
    environment:
      - ACCEPT_EULA=Y
      # Strong SA password for local development only. You may change it if needed.
      - MSSQL_SA_PASSWORD=LocalStrong!Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    restart: unless-stopped

  # One-off initializer to create the ImageNet database and the ImageNetUser login for local use
  sqlserver-init:
    image: mcr.microsoft.com/mssql-tools
    depends_on:
      - sqlserver
    environment:
      - SA_PASSWORD=LocalStrong!Passw0rd
    entrypoint: ["/bin/bash", "-lc"]
    command: >-
      until /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P $SA_PASSWORD -Q 'SELECT 1' >/dev/null 2>&1; do
        echo 'Waiting for SQL Server to be available...'; sleep 2;
      done;
      echo 'SQL Server is up. Initializing database and user...';
      /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P $SA_PASSWORD -Q "IF DB_ID('ImageNet') IS NULL CREATE DATABASE ImageNet;";
      /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P $SA_PASSWORD -Q "IF NOT EXISTS (SELECT * FROM sys.sql_logins WHERE name = 'ImageNetUser') CREATE LOGIN ImageNetUser WITH PASSWORD='ImageNet@123!', CHECK_POLICY=OFF;";
      /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P $SA_PASSWORD -d ImageNet -Q "IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = 'ImageNetUser') CREATE USER ImageNetUser FOR LOGIN ImageNetUser; EXEC sp_addrolemember 'db_owner', 'ImageNetUser';";
      echo 'Database initialization finished.'
    restart: "no"

volumes:
  mssql_data: